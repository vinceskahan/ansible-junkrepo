---

#--------------------------
#
# todo - support RedHat(ish)
#

- name: install weewx optional prerequisites
  apt: package={{ item }} state=present
  with_items:
     - sqlite3
     - ftp
     - rsync
  when:
    ansible_os_family == "Debian"

- name: install weewx mandatory prerequisites
  apt: package={{ item }} state=present
  with_items:
     - python-configobj
     - python-cheetah
     - python-imaging
     - python-serial
     - python-usb
     - python-dev
     - python-pip
     - sqlite3
  when:
    ansible_os_family == "Debian"

#------------------------- 
#
# common to all
#
# todo - do not do this if already done unless a flag is set saying reinstall

- get_url:
      url="http://sourceforge.net/projects/weewx/files/latest/download?source=files"
      dest="/tmp/weewx.tgz"
 
- name: make tmpdir to build in
  file: dest=/tmp/weewx state=directory
 
# note the options here, create a version-neutral tree we can script around
- name: extract weewx
  command: tar zxvf /tmp/weewx.tgz -C /tmp/weewx --strip-components=1
 
- name: build weewx
  command: chdir=/tmp/weewx ./setup.py build 
 
- name: install weewx
  command: chdir=/tmp/weewx ./setup.py install --quiet

- name: install startup file
  command: cp /tmp/weewx/util/init.d/weewx.debian /etc/init.d/weewx

#------------------------- 
#
# todo - support RedHat(ish)
#

- name: set to start on bootup
  command: update-rc.d weewx defaults 98
  when:
    ansible_os_family == "Debian"
 
- file: path=/etc/init.d/weewx mode=0755
  when:
    ansible_os_family == "Debian"

#------------------------- 
#
# common to all
#

# hope the init.d file starts late enough for ntp to be up
- name: fire it up
  command: service weewx start

